---
layout: default
title: "Universal TMX Viewer"
permalink: /tmx_viewer/
---

<div class="tmx-viewer-page" style="max-width: 900px; margin: 0 auto;">

    <div class="back-nav" style="margin-bottom: 20px;">
        <a href="{{ '/assets/' | relative_url }}">&larr; Back to File List</a>
    </div>

    <div style="margin-bottom: 10px;">
        <span style="background-color: #f3e5f5; color: #7b1fa2; padding: 4px 8px; font-size: 0.75rem; font-weight: bold; border-radius: 4px; letter-spacing: 1px; text-transform: uppercase;">
            Dynamic Viewer
        </span>
    </div>

    <h1 id="viewer-title" class="post-title">Loading...</h1>
    
    <div class="source-bar" style="background: #f9f9f9; padding: 12px 15px; border-left: 4px solid #8b0000; margin: 20px 0 30px 0; font-size: 0.9rem;">
        <strong style="color: #333;">File:</strong> <span id="file-name-display" style="font-family: monospace; color: #666;">...</span>
    </div>

    <div id="loading-msg" style="text-align: center; padding: 40px; color: #666; font-style: italic;">
        Initializing...
    </div>

    <div id="tmx-grid" class="tmx-container" style="display: none;">
        <div class="tmx-header">
            <div class="tmx-col-head" id="head-src">Source</div>
            <div class="tmx-col-head" id="head-tgt">Target</div>
        </div>
        </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    
    // A. GET FILE FROM URL PARAMETER (?file=xxx.tmx)
    const urlParams = new URLSearchParams(window.location.search);
    const fileName = urlParams.get('file');
    
    const msgContainer = document.getElementById("loading-msg");
    const grid = document.getElementById("tmx-grid");

    if (!fileName) {
        msgContainer.innerHTML = "No file selected. <a href='/assets/'>Go to File List</a>";
        document.getElementById("viewer-title").innerText = "No File Selected";
        return;
    }

    // Update UI
    document.getElementById("viewer-title").innerText = fileName.replace(".tmx", "").replace(/[-_]/g, " "); // Make pretty title
    document.getElementById("file-name-display").innerText = fileName;
    const tmxUrl = "{{ '/assets/sources/' | relative_url }}" + fileName;

    console.log("Magic loading:", tmxUrl);

    // B. FETCH AND AUTO-DETECT LANGUAGES
    fetch(tmxUrl)
        .then(response => {
            if (!response.ok) throw new Error("File not found in assets/sources/");
            return response.text();
        })
        .then(str => {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(str, "text/xml");
            
            if (xmlDoc.querySelector("parsererror")) throw new Error("Invalid XML.");

            const body = xmlDoc.getElementsByTagName("body")[0];
            const tus = body.getElementsByTagName("tu");

            if (tus.length === 0) throw new Error("Empty TMX file.");

            // C. AUTO-DETECT LANGUAGES (The "Magic" Part)
            // We scan the first translation unit to guess the languages
            let firstUnit = tus[0].getElementsByTagName("tuv");
            let detectedSrc = "";
            let detectedTgt = "";

            if (firstUnit.length >= 1) detectedSrc = firstUnit[0].getAttribute("xml:lang");
            if (firstUnit.length >= 2) detectedTgt = firstUnit[1].getAttribute("xml:lang");

            // Update Headers
            document.getElementById("head-src").innerText = detectedSrc || "Language A";
            document.getElementById("head-tgt").innerText = detectedTgt || "Language B";

            console.log(`Auto-detected: ${detectedSrc} -> ${detectedTgt}`);

            // D. RENDER LOOP
            for (let i = 0; i < tus.length; i++) {
                let tu = tus[i];
                let tuvs = tu.getElementsByTagName("tuv");
                let srcText = "";
                let tgtText = "";

                for (let j = 0; j < tuvs.length; j++) {
                    let lang = tuvs[j].getAttribute("xml:lang");
                    let seg = tuvs[j].getElementsByTagName("seg")[0];
                    let text = seg ? seg.textContent : "";

                    // Match based on what we detected
                    if (lang === detectedSrc) srcText = text;
                    else if (lang === detectedTgt) tgtText = text;
                    // Fallback: If we missed the detection, just fill slots
                    else if (!srcText) srcText = text;
                    else if (!tgtText) tgtText = text;
                }

                let row = document.createElement("div");
                row.className = "tmx-row";
                row.innerHTML = `
                    <div class="tmx-cell source">${srcText}</div>
                    <div class="tmx-cell target">${tgtText}</div>
                `;
                grid.appendChild(row);
            }

            msgContainer.style.display = "none";
            grid.style.display = "block";
        })
        .catch(err => {
            msgContainer.style.color = "red";
            msgContainer.innerHTML = "Error: " + err.message;
        });
});
</script>

<style>
    /* Reuse the same CSS from the layout here */
    .tmx-container { border-top: 2px solid #8b0000; font-family: "Georgia", serif; }
    .tmx-header { display: grid; grid-template-columns: 1fr 1fr; position: sticky; top: 0; background: white; border-bottom: 1px solid #ccc; z-index: 100; }
    .tmx-col-head { padding: 10px; font-weight: bold; color: #8b0000; text-transform: uppercase; letter-spacing: 1px; font-size: 0.8rem; font-family: sans-serif; }
    .tmx-row { display: grid; grid-template-columns: 1fr 1fr; border-bottom: 1px solid #eee; }
    .tmx-row:hover { background-color: #fffaf0; }
    .tmx-cell { padding: 10px; line-height: 1.5; white-space: pre-wrap; }
    .tmx-cell.source { border-right: 1px solid #eee; color: #555; }
    @media (max-width: 768px) {
        .tmx-header { display: none; }
        .tmx-row { display: flex; flex-direction: column; }
        .tmx-cell.source { border-right: none; border-bottom: 1px dashed #eee; }
    }
</style>