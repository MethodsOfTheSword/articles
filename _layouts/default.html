<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} | {{ site.title }}</title>
    <link rel="stylesheet" href="{{ '/assets/css/style.css' | relative_url }}"> 
</head>
<body>

<article>
    <div style="margin-bottom: 40px; font-family: sans-serif; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;">
        {% if page.url != "/" %}
            <a href="{{ '/' | relative_url }}" style="text-decoration: none; color: #8b0000;">‚Üê Back to Archive</a>
        {% endif %}
    </div>
    
    {% if page.title %}
    <h1>{{ page.title }}</h1>
    {% endif %}

<ul style="font-family: monospace; font-size: 0.9rem;">
{% for post in site.posts %}
  <li>
    RAW OBJECT: {{ post | inspect }}
  </li>
{% endfor %}
</ul>

    {% if page.subtitle %}
    <div style="font-style: italic; color: #555; border-bottom: 1px solid #e0e0e0; padding-bottom: 20px; margin-bottom: 40px;">
        {{ page.date | date: "%B %d, %Y" }} ‚Ä¢ {{ page.subtitle }}
    </div>
    {% endif %}

    {% assign article_type = page.article_type | default: 'analysis' %}

    {% if article_type == 'translation' %}
        
        {% if page.source_link or page.transcription_link or page.tmx_link %}
        <div class="download-bar">
            <span class="download-label">Archive Assets:</span>
            
            {% comment %} Helper block for clean linking {% endcomment %}
            {% assign base_assets_url = '/assets/sources/' | relative_url %}
            
            {% if page.source_link %}
                {% assign src_url = page.source_link %}
                {% unless src_url contains 'http' %}{% assign src_url = base_assets_url | append: page.source_link %}{% endunless %}
                
                <a href="{{ src_url }}" target="_blank" class="dl-link">
                    üñºÔ∏è {{ page.source_label | default: "Original Source" }}
                </a>
            {% endif %}

            {% if page.transcription_link %}
                {% assign txt_url = page.transcription_link %}
                {% unless txt_url contains 'http' or txt_url contains '/' %}{% assign txt_url = base_assets_url | append: page.transcription_link %}{% endunless %}
                
                <a href="{{ txt_url }}" target="_blank" class="dl-link">
                    üìù {{ page.transcription_label | default: "Transcription" }}
                </a>
            {% endif %}

            {% if page.tmx_link %}
                <a href="{{ base_assets_url }}{{ page.tmx_link }}" download class="dl-link">
                    üíæ TMX
                </a>
            {% endif %}
            
        </div>
        <hr class="fencing-divider">
        {% endif %}
    {% endif %}

    <div class="post-content">
        {{ content }}
    </div>

    <hr class="fencing-divider">

    {% if article_type == 'translation' %}
        
    {% comment %} 1. Define the Unique ID based on confirmed working variables {% endcomment %}
{% assign post_date = page.date | date: "%Y-%m-%d" %}
{% assign base_slug = page.slug %} 
{% assign unique_id_prefix = post_date | append: "-" | append: base_slug | append: "-" %} 
{% comment %} This calculates the guaranteed search string: YYYY-MM-DD-slug- {% endcomment %}

{% assign found_links = false %}

<div class="language-switcher" style="text-align: center; margin: 3rem 0 1rem 0;">
    <span style="font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: #8b0000; font-weight: bold;">
        View Other Versions:
    </span>
    
    {% comment %} 2. SCAN ALL POSTS FOR MATCHING PREFIX {% endcomment %}
{% for post in site.posts %}
    {% assign post_name_base = post.basename %}
    
    {% comment %} Define the minimum length a companion must have to be valid {% endcomment %}
    {% assign min_length = unique_id_prefix | size | plus: 3 %}

    {% comment %} Check 1: Must be longer than the prefix AND not the current page {% endcomment %}
    {% if post_name_base | size > min_length and post.url != page.url %}
        
        {% comment %} Check 2: Slice the post name to the length of the prefix and compare {% endcomment %}
        {% assign post_prefix = post_name_base | slice: 0, unique_id_prefix | size %}
        
        {% if post_prefix == unique_id_prefix %}
            
            {% assign found_links = true %}
            
            {% comment %} Logic Success: Extract suffix and render button {% endcomment %}
            {% assign suffix = post_name_base | remove: unique_id_prefix %}
            {% assign lang_code = suffix | split: "_" | last %}
            
            <a href="{{ post.url | relative_url }}" class="dl-link" style="background: white; border: none; font-size: 1rem; color: #333;">
                
                {% comment %} LABEL LOGIC: Check the suffix for role {% endcomment %}
                {% if suffix contains "transcription_" %}
                    üìù Original {{ lang_code | upcase }} Transcription
                {% elsif suffix contains "translation_" %}
                    üá´üá∑ {{ lang_code | upcase }} Translation
                {% endif %}

            </a>
        {% endif %}
    {% endif %}
{% endfor %}
    
    {% comment %} 3. ADD FALLBACK LINK TO ENGLISH DEFAULT (If viewing a secondary page) {% endcomment %}
    {% if page.name contains "-translation_" or page.name contains "-transcription_" %}
        {% assign english_default_filename = post_date | append: "-" | append: base_slug | append: ".md" %}
        
        {% for post in site.posts %}
            {% if post.name == english_default_filename %}
                <a href="{{ post.url | relative_url }}" class="dl-link" style="background: white; border: none; font-size: 1rem; color: #333;">
                    üá∫üá∏ English Translation
                </a>
            {% endif %}
        {% endfor %}
    {% endif %}

    {% comment %} 4. MESSAGE IF NOTHING WAS FOUND {% endcomment %}
    {% unless found_links or page.name contains "-translation_" or page.name contains "-transcription_" %}
        <p style="text-align: center; font-size: 0.9rem; color: #888;">No companion versions found.</p>
    {% endunless %}

</div>
    {% endif %}

    {% if page.author %}
    <div style="text-align: right; margin-top: 60px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px;">
        {{ page.author }}
    </div>
    {% endif %}
    
    <footer style="text-align: center; font-size: 0.8rem; margin-top: 80px; color: #666; border-top: 1px solid #eee; padding-top: 20px;">
        &copy; {{ site.time | date: '%Y' }} {{ site.author }}. All Rights Reserved.
    </footer>
</article>

</body>
</html>